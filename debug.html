<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ªè´´æ¿ç®¡ç†å™¨ - è°ƒè¯•ç‰ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 800px; margin: 0 auto; }
        h1 {
            color: white; text-align: center; margin-bottom: 20px;
            font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .debug-box {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .debug-title {
            font-size: 1.2em; margin-bottom: 15px; color: #333;
            font-weight: bold;
        }
        .debug-item {
            padding: 8px; margin: 5px 0; border-radius: 4px;
            font-size: 14px; font-family: monospace;
        }
        .debug-success { background: #d4edda; color: #155724; }
        .debug-error { background: #f8d7da; color: #721c24; }
        .debug-warning { background: #fff3cd; color: #856404; }
        .debug-info { background: #d1ecf1; color: #0c5460; }
        .paste-box {
            background: white; border-radius: 12px; padding: 30px;
            margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
        }
        .paste-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 15px 40px; font-size: 18px;
            border-radius: 8px; cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .paste-btn:hover { transform: translateY(-2px); }
        .paste-btn:disabled {
            opacity: 0.5; cursor: not-allowed;
        }
        .test-buttons {
            display: flex; gap: 10px; justify-content: center;
            margin-top: 15px; flex-wrap: wrap;
        }
        .test-btn {
            background: #28a745; color: white; border: none;
            padding: 10px 20px; border-radius: 6px; cursor: pointer;
            font-size: 14px;
        }
        .test-btn:hover { background: #218838; }
        .list-container {
            background: white; border-radius: 12px; padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .clipboard-list { list-style: none; }
        .clipboard-item {
            background: #f8f9fa; border: 1px solid #e9ecef;
            border-radius: 8px; padding: 15px; margin-bottom: 10px;
        }
        .notification {
            position: fixed; top: 20px; right: 20px;
            background: #28a745; color: white; padding: 15px 25px;
            border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            opacity: 0; transform: translateY(-20px);
            transition: all 0.3s ease; z-index: 1000;
            max-width: 400px;
        }
        .notification.show { opacity: 1; transform: translateY(0); }
        .notification.error { background: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“‹ å‰ªè´´æ¿ç®¡ç†å™¨ - è°ƒè¯•ç‰ˆ</h1>
        
        <div class="debug-box">
            <div class="debug-title">ğŸ” ç³»ç»Ÿæ£€æµ‹ç»“æœ</div>
            <div id="debugInfo"></div>
        </div>

        <div class="paste-box">
            <button class="paste-btn" id="pasteBtn" onclick="pasteFromClipboard()">
                ğŸ“Œ ç²˜è´´å‰ªè´´æ¿å†…å®¹
            </button>
            <div class="test-buttons">
                <button class="test-btn" onclick="checkPermissions()">æ£€æŸ¥æƒé™</button>
                <button class="test-btn" onclick="requestPermission()">è¯·æ±‚æƒé™</button>
                <button class="test-btn" onclick="testClipboard()">æµ‹è¯•å‰ªè´´æ¿</button>
            </div>
        </div>

        <div class="list-container">
            <h2>å‰ªè´´æ¿å†å²</h2>
            <ul id="clipboardList" class="clipboard-list">
                <li>æš‚æ— å†…å®¹</li>
            </ul>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        let items = [];
        let nextId = 1;

        // é¡µé¢åŠ è½½æ—¶æ£€æµ‹
        window.addEventListener('load', () => {
            detectEnvironment();
        });

        function addDebugInfo(message, type = 'info') {
            const debugDiv = document.getElementById('debugInfo');
            const item = document.createElement('div');
            item.className = `debug-item debug-${type}`;
            item.textContent = message;
            debugDiv.appendChild(item);
        }

        function detectEnvironment() {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML = '';

            // 1. æ£€æŸ¥æµè§ˆå™¨
            addDebugInfo(`æµè§ˆå™¨: ${navigator.userAgent.split(' ').pop()}`, 'info');
            
            // 2. æ£€æŸ¥åè®®
            const protocol = window.location.protocol;
            if (protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                addDebugInfo(`âœ… åè®®: ${protocol} (æ”¯æŒå‰ªè´´æ¿API)`, 'success');
            } else {
                addDebugInfo(`âŒ åè®®: ${protocol} (éœ€è¦ HTTPS æˆ– localhost)`, 'error');
            }

            // 3. æ£€æŸ¥ Clipboard API æ”¯æŒ
            if (navigator.clipboard) {
                addDebugInfo('âœ… æµè§ˆå™¨æ”¯æŒ Clipboard API', 'success');
            } else {
                addDebugInfo('âŒ æµè§ˆå™¨ä¸æ”¯æŒ Clipboard API', 'error');
                document.getElementById('pasteBtn').disabled = true;
            }

            // 4. æ£€æŸ¥ readText æ–¹æ³•
            if (navigator.clipboard && navigator.clipboard.readText) {
                addDebugInfo('âœ… æ”¯æŒ clipboard.readText()', 'success');
            } else {
                addDebugInfo('âŒ ä¸æ”¯æŒ clipboard.readText()', 'error');
            }

            // 5. æ£€æŸ¥æ˜¯å¦åœ¨ iframe ä¸­
            if (window.self !== window.top) {
                addDebugInfo('âš ï¸ è­¦å‘Š: é¡µé¢åœ¨ iframe ä¸­ï¼Œå¯èƒ½å½±å“æƒé™', 'warning');
            }

            // 6. æ£€æŸ¥ Permissions API
            if (navigator.permissions) {
                addDebugInfo('âœ… æµè§ˆå™¨æ”¯æŒ Permissions API', 'success');
                checkPermissions();
            } else {
                addDebugInfo('âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒ Permissions APIï¼ˆæ— æ³•æ£€æŸ¥æƒé™çŠ¶æ€ï¼‰', 'warning');
            }
        }

        async function checkPermissions() {
            if (!navigator.permissions) {
                showNotification('æµè§ˆå™¨ä¸æ”¯æŒæƒé™æ£€æŸ¥ API', 'error');
                return;
            }

            try {
                const result = await navigator.permissions.query({ name: 'clipboard-read' });
                const status = result.state;
                
                if (status === 'granted') {
                    addDebugInfo('âœ… å‰ªè´´æ¿è¯»å–æƒé™: å·²æˆæƒ', 'success');
                } else if (status === 'prompt') {
                    addDebugInfo('âš ï¸ å‰ªè´´æ¿è¯»å–æƒé™: éœ€è¦è¯¢é—®ç”¨æˆ·', 'warning');
                } else {
                    addDebugInfo('âŒ å‰ªè´´æ¿è¯»å–æƒé™: å·²æ‹’ç»', 'error');
                }

                result.onchange = () => {
                    addDebugInfo(`æƒé™çŠ¶æ€å˜æ›´: ${result.state}`, 'info');
                };
            } catch (err) {
                addDebugInfo(`æƒé™æ£€æŸ¥å¤±è´¥: ${err.message}`, 'warning');
            }
        }

        async function requestPermission() {
            try {
                await navigator.clipboard.readText();
                showNotification('âœ… æƒé™è¯·æ±‚æˆåŠŸï¼', 'success');
                checkPermissions();
            } catch (err) {
                showNotification(`âŒ æƒé™è¯·æ±‚å¤±è´¥: ${err.message}`, 'error');
                addDebugInfo(`æƒé™è¯·æ±‚é”™è¯¯: ${err.name} - ${err.message}`, 'error');
            }
        }

        async function testClipboard() {
            addDebugInfo('--- å¼€å§‹æµ‹è¯•å‰ªè´´æ¿ ---', 'info');
            
            try {
                addDebugInfo('æ­£åœ¨å°è¯•è¯»å–å‰ªè´´æ¿...', 'info');
                const text = await navigator.clipboard.readText();
                addDebugInfo(`âœ… æˆåŠŸè¯»å–! å†…å®¹é•¿åº¦: ${text.length} å­—ç¬¦`, 'success');
                addDebugInfo(`å†…å®¹é¢„è§ˆ: "${text.substring(0, 50)}..."`, 'info');
                showNotification('âœ… å‰ªè´´æ¿æµ‹è¯•æˆåŠŸï¼', 'success');
            } catch (err) {
                addDebugInfo(`âŒ è¯»å–å¤±è´¥: ${err.name}`, 'error');
                addDebugInfo(`é”™è¯¯è¯¦æƒ…: ${err.message}`, 'error');
                showNotification(`âŒ æµ‹è¯•å¤±è´¥: ${err.message}`, 'error');
                
                // ç»™å‡ºå…·ä½“å»ºè®®
                if (err.name === 'NotAllowedError') {
                    addDebugInfo('ğŸ’¡ å»ºè®®: ç”¨æˆ·æ‹’ç»äº†æƒé™ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸å‰ªè´´æ¿è®¿é—®', 'warning');
                } else if (err.name === 'NotFoundError') {
                    addDebugInfo('ğŸ’¡ å»ºè®®: å‰ªè´´æ¿å¯èƒ½ä¸ºç©ºï¼Œè¯·å…ˆå¤åˆ¶ä¸€äº›å†…å®¹', 'warning');
                }
            }
        }

        async function pasteFromClipboard() {
            try {
                addDebugInfo('ç”¨æˆ·ç‚¹å‡»ç²˜è´´æŒ‰é’®', 'info');
                const text = await navigator.clipboard.readText();
                
                if (!text || text.trim() === '') {
                    showNotification('âš ï¸ å‰ªè´´æ¿ä¸ºç©º', 'error');
                    addDebugInfo('å‰ªè´´æ¿å†…å®¹ä¸ºç©º', 'warning');
                    return;
                }

                const newItem = {
                    id: nextId++,
                    content: text
                };
                items.unshift(newItem);
                
                renderList();
                showNotification('âœ… å·²æ·»åŠ åˆ°åˆ—è¡¨', 'success');
                addDebugInfo(`âœ… æˆåŠŸæ·»åŠ å†…å®¹ (${text.length} å­—ç¬¦)`, 'success');
            } catch (err) {
                showNotification(`âŒ ${err.name}: ${err.message}`, 'error');
                addDebugInfo(`âŒ ç²˜è´´å¤±è´¥: ${err.name} - ${err.message}`, 'error');
                
                // è¯¦ç»†é”™è¯¯åˆ†æ
                if (err.name === 'NotAllowedError') {
                    addDebugInfo('ğŸ’¡ åŸå› : ç”¨æˆ·æ‹’ç»äº†å‰ªè´´æ¿æƒé™', 'warning');
                    addDebugInfo('ğŸ’¡ è§£å†³: è¯·åœ¨æµè§ˆå™¨åœ°å€æ å·¦ä¾§ç‚¹å‡»é”å›¾æ ‡ï¼Œå…è®¸å‰ªè´´æ¿æƒé™', 'warning');
                } else if (err.name === 'NotFoundError') {
                    addDebugInfo('ğŸ’¡ åŸå› : å‰ªè´´æ¿ä¸­æ²¡æœ‰æ–‡æœ¬å†…å®¹', 'warning');
                }
            }
        }

        function renderList() {
            const list = document.getElementById('clipboardList');
            if (items.length === 0) {
                list.innerHTML = '<li>æš‚æ— å†…å®¹</li>';
                return;
            }

            list.innerHTML = items.map(item => `
                <li class="clipboard-item">
                    <div><strong>ID ${item.id}:</strong></div>
                    <div>${escapeHtml(item.content.substring(0, 200))}${item.content.length > 200 ? '...' : ''}</div>
                </li>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + (type === 'error' ? 'error' : '');
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }
    </script>
</body>
</html>